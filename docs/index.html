<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Densovirus reads from Dane County, Wisconsin air samples mapped to HuCSFDV1</title>

    <!-- IGV.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/igv@2.15.11/dist/css/igv.css">

    <!-- Custom styles -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 30px;
        }
        .viewer-container {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        #igvDiv {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            min-height: 500px;
        }
        .sample-selector {
            margin: 20px 0;
        }
        select {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            max-width: 500px;
        }
        button {
            padding: 8px 16px;
            margin: 0 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .info-panel {
            margin: 20px 0;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        .error {
            color: #dc3545;
            padding: 10px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            padding: 10px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Densovirus reads from Dane County, Wisconsin air samples mapped to HuCSFDV1</h1>

        <div class="info-panel">
            <p><strong>Interactive Genome Viewer</strong></p>
            <p>This page displays BAM alignment files from various air sample collections using IGV.js.
               Use the controls below to select different samples and navigate the genome.</p>
        </div>

        <div class="sample-selector">
            <label for="sampleSelect">Select Sample: </label>
            <select id="sampleSelect">
                <option value="">-- Choose a sample --</option>
                <optgroup label="Wastewater Samples">
                    <option value="WW-1">WW-1</option>
                    <option value="WW-2">WW-2</option>
                    <option value="WW-3">WW-3</option>
                    <option value="WW-4">WW-4</option>
                </optgroup>
                <optgroup label="Elementary School 001">
                    <option value="elementary-school-001-20250129-dilution-1-4">ES-001 2025-01-29 (dilution 1:4)</option>
                    <option value="elementary-school-001-20250129-dilution-1-8">ES-001 2025-01-29 (dilution 1:8)</option>
                    <option value="elementary-school-001-20250129-dilution-1-16">ES-001 2025-01-29 (dilution 1:16)</option>
                    <option value="elementary-school-001-20250129-dilution-1-32">ES-001 2025-01-29 (dilution 1:32)</option>
                    <option value="elementary-school-001-20250129-undiluted">ES-001 2025-01-29 (undiluted)</option>
                    <option value="elementary-school-001-20250901-pooled">ES-001 2025-09-01 (pooled)</option>
                    <option value="elementary-school-001-20250915-pooled">ES-001 2025-09-15 (pooled)</option>
                    <option value="elementary-school-001-20250922-pooled">ES-001 2025-09-22 (pooled)</option>
                    <option value="elementary-school-001-20250929-pooled">ES-001 2025-09-29 (pooled)</option>
                </optgroup>
                <optgroup label="Elementary School 002">
                    <option value="elementary-school-002-20241018-ZCC">ES-002 2024-10-18 (ZCC)</option>
                    <option value="elementary-school-002-20241023-1plex">ES-002 2024-10-23 (1plex)</option>
                    <option value="elementary-school-002-20241023-3plex">ES-002 2024-10-23 (3plex)</option>
                    <option value="elementary-school-002-20241023-9plex">ES-002 2024-10-23 (9plex)</option>
                </optgroup>
                <optgroup label="Elementary School 003">
                    <option value="elementary-school-003-20250901-pooled">ES-003 2025-09-01 (pooled)</option>
                    <option value="elementary-school-003-20250915-pooled">ES-003 2025-09-15 (pooled)</option>
                    <option value="elementary-school-003-20250929-pooled">ES-003 2025-09-29 (pooled)</option>
                </optgroup>
                <optgroup label="Elementary School 004">
                    <option value="elementary-school-004-20241121-1plex">ES-004 2024-11-21 (1plex)</option>
                    <option value="elementary-school-004-20241121-3plex">ES-004 2024-11-21 (3plex)</option>
                    <option value="elementary-school-004-20241121-9plex">ES-004 2024-11-21 (9plex)</option>
                    <option value="elementary-school-004-20241125-ZCC">ES-004 2024-11-25 (ZCC)</option>
                    <option value="elementary-school-004-20250901-pooled">ES-004 2025-09-01 (pooled)</option>
                    <option value="elementary-school-004-20250915-pooled">ES-004 2025-09-15 (pooled)</option>
                    <option value="elementary-school-004-20250922-pooled">ES-004 2025-09-22 (pooled)</option>
                    <option value="elementary-school-004-20250929-pooled">ES-004 2025-09-29 (pooled)</option>
                </optgroup>
                <optgroup label="Elementary School 005">
                    <option value="elementary-school-005-20250901-pooled">ES-005 2025-09-01 (pooled)</option>
                    <option value="elementary-school-005-20250915-pooled">ES-005 2025-09-15 (pooled)</option>
                    <option value="elementary-school-005-20250922-pooled">ES-005 2025-09-22 (pooled)</option>
                    <option value="elementary-school-005-20250929-pooled">ES-005 2025-09-29 (pooled)</option>
                </optgroup>
                <optgroup label="Elementary School 006">
                    <option value="elementary-school-006-20241213-ZCC">ES-006 2024-12-13 (ZCC)</option>
                    <option value="elementary-school-006-20241217-1plex">ES-006 2024-12-17 (1plex)</option>
                    <option value="elementary-school-006-20241217-3plex">ES-006 2024-12-17 (3plex)</option>
                    <option value="elementary-school-006-20241217-9plex">ES-006 2024-12-17 (9plex)</option>
                </optgroup>
                <optgroup label="Elementary School 007">
                    <option value="elementary-school-007-20241212-1plex">ES-007 2024-12-12 (1plex)</option>
                    <option value="elementary-school-007-20241212-3plex">ES-007 2024-12-12 (3plex)</option>
                    <option value="elementary-school-007-20241212-9plex">ES-007 2024-12-12 (9plex)</option>
                    <option value="elementary-school-007-20241216-ZCC">ES-007 2024-12-16 (ZCC)</option>
                    <option value="elementary-school-007-20250901-pooled">ES-007 2025-09-01 (pooled)</option>
                    <option value="elementary-school-007-20250915-pooled">ES-007 2025-09-15 (pooled)</option>
                    <option value="elementary-school-007-20250922-pooled">ES-007 2025-09-22 (pooled)</option>
                    <option value="elementary-school-007-20250929-pooled">ES-007 2025-09-29 (pooled)</option>
                </optgroup>
                <optgroup label="Elementary School 008">
                    <option value="elementary-school-008-20250901-pooled">ES-008 2025-09-01 (pooled)</option>
                    <option value="elementary-school-008-20250915-pooled">ES-008 2025-09-15 (pooled)</option>
                    <option value="elementary-school-008-20250922-pooled">ES-008 2025-09-22 (pooled)</option>
                </optgroup>
                <optgroup label="Elementary School 009">
                    <option value="elementary-school-009-20250206-1plex">ES-009 2025-02-06 (1plex)</option>
                    <option value="elementary-school-009-20250206-3plex">ES-009 2025-02-06 (3plex)</option>
                    <option value="elementary-school-009-20250206-9plex">ES-009 2025-02-06 (9plex)</option>
                    <option value="elementary-school-009-20250210-ZCC">ES-009 2025-02-10 (ZCC)</option>
                    <option value="elementary-school-009-20250901-pooled">ES-009 2025-09-01 (pooled)</option>
                    <option value="elementary-school-009-20250915-pooled">ES-009 2025-09-15 (pooled)</option>
                    <option value="elementary-school-009-20250922-pooled">ES-009 2025-09-22 (pooled)</option>
                    <option value="elementary-school-009-20250929-pooled">ES-009 2025-09-29 (pooled)</option>
                </optgroup>
                <optgroup label="K-12 School 001">
                    <option value="k12-school-001-20240906-1plex">K12-001 2024-09-06 (1plex)</option>
                    <option value="k12-school-001-20240906-3plex">K12-001 2024-09-06 (3plex)</option>
                    <option value="k12-school-001-20240906-9plex">K12-001 2024-09-06 (9plex)</option>
                    <option value="k12-school-001-20240910-ZCC">K12-001 2024-09-10 (ZCC)</option>
                    <option value="k12-school-001-20250901-pooled">K12-001 2025-09-01 (pooled)</option>
                    <option value="k12-school-001-20250915-pooled">K12-001 2025-09-15 (pooled)</option>
                    <option value="k12-school-001-20250922-pooled">K12-001 2025-09-22 (pooled)</option>
                </optgroup>
                <optgroup label="Middle School 001">
                    <option value="middle-school-001-20250922-pooled">MS-001 2025-09-22 (pooled)</option>
                </optgroup>
                <optgroup label="Middle School 002">
                    <option value="middle-school-002-20250901-pooled">MS-002 2025-09-01 (pooled)</option>
                    <option value="middle-school-002-20250915-pooled">MS-002 2025-09-15 (pooled)</option>
                    <option value="middle-school-002-20250922-pooled">MS-002 2025-09-22 (pooled)</option>
                    <option value="middle-school-002-20250929-pooled">MS-002 2025-09-29 (pooled)</option>
                </optgroup>
                <optgroup label="Middle School 003">
                    <option value="middle-school-003-20250220-ZCC">MS-003 2025-02-20 (ZCC)</option>
                    <option value="middle-school-003-20250226-1plex">MS-003 2025-02-26 (1plex)</option>
                    <option value="middle-school-003-20250226-3plex">MS-003 2025-02-26 (3plex)</option>
                    <option value="middle-school-003-20250226-9plex">MS-003 2025-02-26 (9plex)</option>
                    <option value="middle-school-003-20250901-pooled">MS-003 2025-09-01 (pooled)</option>
                    <option value="middle-school-003-20250915-pooled">MS-003 2025-09-15 (pooled)</option>
                    <option value="middle-school-003-20250922-pooled">MS-003 2025-09-22 (pooled)</option>
                    <option value="middle-school-003-20250929-pooled">MS-003 2025-09-29 (pooled)</option>
                </optgroup>
                <optgroup label="Middle School 004">
                    <option value="middle-school-004-20250901-pooled">MS-004 2025-09-01 (pooled)</option>
                    <option value="middle-school-004-20250915-pooled">MS-004 2025-09-15 (pooled)</option>
                    <option value="middle-school-004-20250922-pooled">MS-004 2025-09-22 (pooled)</option>
                    <option value="middle-school-004-20250929-pooled">MS-004 2025-09-29 (pooled)</option>
                </optgroup>
                <optgroup label="Middle School 005">
                    <option value="middle-school-005-20250212-unpooled">MS-005 2025-02-12 (unpooled)</option>
                    <option value="middle-school-005-20250216-unpooled">MS-005 2025-02-16 (unpooled)</option>
                    <option value="middle-school-005-20250901-pooled">MS-005 2025-09-01 (pooled)</option>
                    <option value="middle-school-005-20250915-pooled">MS-005 2025-09-15 (pooled)</option>
                    <option value="middle-school-005-20250922-pooled">MS-005 2025-09-22 (pooled)</option>
                    <option value="middle-school-005-20250929-pooled">MS-005 2025-09-29 (pooled)</option>
                    <option value="middle-school-005-pooled-combo">MS-005 (pooled combo)</option>
                </optgroup>
                <optgroup label="High School 001">
                    <option value="high-school-001-20250128-ZCC">HS-001 2025-01-28 (ZCC)</option>
                    <option value="high-school-001-20250131-1plex">HS-001 2025-01-31 (1plex)</option>
                    <option value="high-school-001-20250131-3plex">HS-001 2025-01-31 (3plex)</option>
                    <option value="high-school-001-20250131-9plex">HS-001 2025-01-31 (9plex)</option>
                    <option value="high-school-001-20250901-pooled">HS-001 2025-09-01 (pooled)</option>
                    <option value="high-school-001-20250915-pooled">HS-001 2025-09-15 (pooled)</option>
                    <option value="high-school-001-20250929-pooled">HS-001 2025-09-29 (pooled)</option>
                </optgroup>
                <optgroup label="High School 002">
                    <option value="high-school-002-20250117-ZCC">HS-002 2025-01-17 (ZCC)</option>
                    <option value="high-school-002-20250121-1plex">HS-002 2025-01-21 (1plex)</option>
                    <option value="high-school-002-20250121-3plex">HS-002 2025-01-21 (3plex)</option>
                    <option value="high-school-002-20250121-9plex">HS-002 2025-01-21 (9plex)</option>
                    <option value="high-school-002-20250221-unpooled">HS-002 2025-02-21 (unpooled)</option>
                    <option value="high-school-002-20250225-unpooled">HS-002 2025-02-25 (unpooled)</option>
                    <option value="high-school-002-20250901-pooled">HS-002 2025-09-01 (pooled)</option>
                    <option value="high-school-002-20250915-pooled">HS-002 2025-09-15 (pooled)</option>
                    <option value="high-school-002-20250922-pooled">HS-002 2025-09-22 (pooled)</option>
                    <option value="high-school-002-20250929-pooled">HS-002 2025-09-29 (pooled)</option>
                    <option value="high-school-002-pooled-combo">HS-002 (pooled combo)</option>
                </optgroup>
                <optgroup label="High School 003">
                    <option value="high-school-003-20250915-pooled">HS-003 2025-09-15 (pooled)</option>
                    <option value="high-school-003-20250922-pooled">HS-003 2025-09-22 (pooled)</option>
                    <option value="high-school-003-20250929-pooled">HS-003 2025-09-29 (pooled)</option>
                </optgroup>
                <optgroup label="Healthcare">
                    <option value="healthcare-001-20250922-pooled">Healthcare-001 2025-09-22 (pooled)</option>
                </optgroup>
            </select>
            <button onclick="loadSample()">Load Sample</button>
            <button onclick="clearViewer()">Clear Viewer</button>
            <button onclick="initializeIGV()">Initialize Viewer</button>
        </div>

        <div class="viewer-container">
            <h2>Genome Browser</h2>
            <div id="statusMessage"></div>
            <div id="igvDiv">
                <div class="loading">Click "Initialize Viewer" to start the genome browser</div>
            </div>
        </div>

        <div class="info-panel">
            <p><strong>Navigation Tips:</strong></p>
            <ul>
                <li>First click "Initialize Viewer" to load the reference genome</li>
                <li>Then select a sample from the dropdown and click "Load Sample"</li>
                <li>Click and drag to pan along the genome</li>
                <li>Use the mouse wheel or zoom controls to zoom in/out</li>
                <li>Click on reads to see detailed alignment information</li>
                <li>Use the search box to jump to specific genomic coordinates</li>
            </ul>
        </div>
    </div>

    <!-- IGV.js -->
    <script src="https://cdn.jsdelivr.net/npm/igv@2.15.11/dist/igv.min.js"></script>

    <script>
        let igvBrowser = null;

        // Function to show status messages
        function showMessage(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info-panel';
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';

            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Initialize IGV with default reference
        async function initializeIGV() {
            // Clear any existing browser
            if (igvBrowser) {
                igvBrowser.removeAllTracks();
                igvBrowser = null;
            }

            // Clear the div
            const igvDiv = document.getElementById('igvDiv');
            igvDiv.innerHTML = '<div class="loading">Initializing genome browser...</div>';

            showMessage('Initializing genome viewer...', 'info');

            const baseUrl = 'https://raw.githubusercontent.com/dholab/common-densoviruses/main';

            const options = {
                genome: {
                    id: "HuCSFDV1",
                    name: "Human CSF-associated densovirus 1",
                    fastaURL: `${baseUrl}/air-samples/vsp/ref/NC_076998.fasta`,
                    tracks: [
                        {
                            name: "Genes",
                            type: "annotation",
                            format: "gff3",
                            url: `${baseUrl}/air-samples/vsp/ref/NC_076998.gff`,
                            displayMode: "EXPANDED",
                            height: 100,
                            color: "rgb(0, 0, 150)"
                        }
                    ]
                },
                locus: "NC_076998.1:1-4900",
                showNavigation: true,
                showRuler: true,
                showCenterGuide: true,
                showCursorTrackingGuide: true,
                showCommandBar: true
            };

            try {
                // Clear the div again before creating browser
                igvDiv.innerHTML = '';

                igvBrowser = await igv.createBrowser(igvDiv, options);
                console.log("IGV browser initialized successfully");
                showMessage('Genome viewer initialized successfully! You can now load samples.', 'success');
            } catch (error) {
                console.error("Error initializing IGV:", error);
                showMessage(`Failed to initialize genome viewer: ${error.message}`, 'error');
                igvDiv.innerHTML = '<div class="error">Failed to initialize viewer. Please check console for details.</div>';
            }
        }

        async function loadSample() {
            const select = document.getElementById('sampleSelect');
            const sampleId = select.value;

            if (!sampleId) {
                alert('Please select a sample');
                return;
            }

            // Initialize IGV if not already done
            if (!igvBrowser) {
                showMessage('Initializing viewer first...', 'info');
                await initializeIGV();

                // Wait a bit for initialization to complete
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            showMessage(`Loading sample: ${sampleId}...`, 'info');

            // Clear existing BAM tracks
            const tracks = igvBrowser.trackViews.filter(tv =>
                tv.track.type === 'alignment'
            );
            for (let trackView of tracks) {
                igvBrowser.removeTrack(trackView.track);
            }

            const baseUrl = 'https://raw.githubusercontent.com/dholab/common-densoviruses/main';

            // Add new BAM track
            const bamConfig = {
                name: sampleId,
                type: "alignment",
                format: "bam",
                url: `${baseUrl}/air-samples/vsp/bam/${sampleId}.bam`,
                indexURL: `${baseUrl}/air-samples/vsp/bam/${sampleId}.bam.bai`,
                displayMode: "SQUISHED",
                alignmentRowHeight: 6,
                coverageTrackHeight: 30,
                colorBy: "strand",
                showSoftClips: true,
                viewAsPairs: false,
                showMismatches: true,
                showAllBases: false
            };

            try {
                await igvBrowser.loadTrack(bamConfig);
                console.log(`Loaded BAM track for ${sampleId}`);
                showMessage(`Successfully loaded: ${sampleId}`, 'success');
            } catch (error) {
                console.error(`Error loading BAM track for ${sampleId}:`, error);
                showMessage(`Failed to load sample ${sampleId}. The file may not be accessible or may be missing an index file.`, 'error');
            }
        }

        function clearViewer() {
            if (igvBrowser) {
                // Remove all alignment tracks
                const tracks = igvBrowser.trackViews.filter(tv =>
                    tv.track.type === 'alignment'
                );
                for (let trackView of tracks) {
                    igvBrowser.removeTrack(trackView.track);
                }
                showMessage('Cleared all loaded samples', 'success');
            }
            document.getElementById('sampleSelect').value = '';
        }

        // Initialize on page load - removed auto-initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded. Click "Initialize Viewer" to start.');
            showMessage('Click "Initialize Viewer" to start the genome browser', 'info');
        });
    </script>
</body>
</html>